"use client";

import { useEffect, useRef, useState, useCallback } from "react";
import { useRouter } from "next/navigation";

type FilterType = "none" | "beautify" | "monochrome";

export default function CameraPage() {
  const router = useRouter();
  const videoRef = useRef<HTMLVideoElement>(null);
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const mediaRecorderRef = useRef<MediaRecorder | null>(null);
  const chunksRef = useRef<Blob[]>([]);
  const animationRef = useRef<number | null>(null);
  const streamRef = useRef<MediaStream | null>(null);
  const timerRef = useRef<NodeJS.Timeout | null>(null);
  const isAnimatingRef = useRef<boolean>(false);

  const [isRecording, setIsRecording] = useState(false);
  const [recordedVideoUrl, setRecordedVideoUrl] = useState<string>("");
  const [cameraActive, setCameraActive] = useState(false);
  const [facingMode, setFacingMode] = useState<"user" | "environment">("environment");
  const [themeColor, setThemeColor] = useState<string>("#ff1493");
  const [recordingTime, setRecordingTime] = useState(0);
  const [currentFilter, setCurrentFilter] = useState<FilterType>("none");
  const [showFilterMenu, setShowFilterMenu] = useState(false);
  const zoomLevelRef = useRef(1);

  useEffect(() => {
    const savedSettings = localStorage.getItem("appSettings");
    const settings = savedSettings ? JSON.parse(savedSettings) : {};
    const color = settings.themeColor || "pink";
    const themeMap: Record<string, string> = {
      pink: "#ff1493",
      blue: "#64b5f6",
      green: "#81c784",
      purple: "#9d4edd",
    };
    setThemeColor(themeMap[color] || "#ff1493");
  }, []);

  const startCamera = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: facingMode },
        audio: true,
      });
      streamRef.current = stream;
      if (videoRef.current) {
        videoRef.current.srcObject = stream;
        setCameraActive(true);
      }
    } catch (err) {
      console.error("ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼:", err);
      alert("ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸ");
    }
  };

  const stopCamera = () => {
    isAnimatingRef.current = false;
    if (animationRef.current) {
      cancelAnimationFrame(animationRef.current);
      animationRef.current = null;
    }
    if (streamRef.current) {
      streamRef.current.getTracks().forEach((track) => track.stop());
      streamRef.current = null;
    }
    if (videoRef.current) {
      videoRef.current.srcObject = null;
    }
    if (canvasRef.current) {
      const ctx = canvasRef.current.getContext("2d");
      if (ctx) {
        ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);
      }
    }
    setCameraActive(false);
  };

  const toggleCamera = () => {
    stopCamera();
    setFacingMode((prev) => (prev === "user" ? "environment" : "user"));
    setTimeout(() => startCamera(), 100);
  };

  const startRecording = () => {
    if (!streamRef.current) return;
    
    chunksRef.current = [];
    
    // canvasãŒã‚ã‚Œã°ãƒ“ãƒ‡ã‚ªã¨canvasã‚’åˆæˆã—ãŸstreamã‚’ä½œæˆ
    let recordStream = streamRef.current;
    
    if (currentFilter !== "none" && canvasRef.current && videoRef.current) {
      // åˆæˆç”¨ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆ
      const compositeCanvas = document.createElement('canvas');
      const video = videoRef.current;
      compositeCanvas.width = video.videoWidth || 1280;
      compositeCanvas.height = video.videoHeight || 720;
      const ctx = compositeCanvas.getContext('2d');
      
      if (ctx) {
        // ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«æç”»
        const drawFrame = () => {
          if (!isRecording) return;
          
          // ãƒ“ãƒ‡ã‚ªã‚’æç”»
          ctx.drawImage(video, 0, 0, compositeCanvas.width, compositeCanvas.height);
          
          // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä¸Šã«æç”»
          if (canvasRef.current) {
            ctx.drawImage(canvasRef.current, 0, 0, compositeCanvas.width, compositeCanvas.height);
          }
          
          requestAnimationFrame(drawFrame);
        };
        drawFrame();
        
        // åˆæˆã‚­ãƒ£ãƒ³ãƒã‚¹ã®streamã‚’å–å¾—
        const canvasStream = compositeCanvas.captureStream(30);
        // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒˆãƒ©ãƒƒã‚¯ã‚’è¿½åŠ 
        const audioTracks = streamRef.current.getAudioTracks();
        audioTracks.forEach(track => canvasStream.addTrack(track));
        recordStream = canvasStream;
      }
    }
    
    const mediaRecorder = new MediaRecorder(recordStream, {
      mimeType: "video/webm;codecs=vp9",
    });

    mediaRecorder.ondataavailable = (e) => {
      if (e.data.size > 0) {
        chunksRef.current.push(e.data);
      }
    };

    mediaRecorder.onstop = () => {
      const blob = new Blob(chunksRef.current, { type: "video/webm" });
      const url = URL.createObjectURL(blob);
      setRecordedVideoUrl(url);
      stopCamera();
      if (timerRef.current) {
        clearInterval(timerRef.current);
      }
      setRecordingTime(0);
    };

    mediaRecorder.start();
    mediaRecorderRef.current = mediaRecorder;
    setIsRecording(true);
    
    // éŒ²ç”»æ™‚é–“ã®ã‚¿ã‚¤ãƒãƒ¼
    setRecordingTime(0);
    timerRef.current = setInterval(() => {
      setRecordingTime((prev) => prev + 1);
    }, 1000);
  };

  const stopRecording = () => {
    if (mediaRecorderRef.current && isRecording) {
      mediaRecorderRef.current.stop();
      setIsRecording(false);
    }
  };

  const saveVideo = () => {
    if (!recordedVideoUrl) return;
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼ˆå®Ÿéš›ã«ã¯ã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰
    const userId = "user123"; // å®Ÿéš›ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
    const videoData = {
      id: `video-${Date.now()}`,
      user_id: userId,
      title: `éŒ²ç”» ${new Date().toLocaleString()}`,
      video_url: recordedVideoUrl,
      created_at: new Date().toISOString(),
    };

    const existingVideos = localStorage.getItem(`videos_${userId}`);
    const videos = existingVideos ? JSON.parse(existingVideos) : [];
    videos.push(videoData);
    localStorage.setItem(`videos_${userId}`, JSON.stringify(videos));

    alert("å‹•ç”»ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
    router.push("/tabs/me/view");
  };

  const retake = () => {
    setRecordedVideoUrl("");
    startCamera();
  };

  useEffect(() => {
    startCamera();
    return () => {
      stopCamera();
      isAnimatingRef.current = false;
      if (animationRef.current) {
        cancelAnimationFrame(animationRef.current);
        animationRef.current = null;
      }
      if (timerRef.current) {
        clearInterval(timerRef.current);
      }
    };
  }, []);

  const formatTime = (seconds: number) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
  };

  const zoomIn = () => {
    zoomLevelRef.current = Math.min(zoomLevelRef.current + 0.5, 3);
  };

  const zoomOut = () => {
    zoomLevelRef.current = Math.max(zoomLevelRef.current - 0.5, 1);
  };

  // é¡”æ¤œå‡ºã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
  const detectAndDrawFilter = useCallback(async () => {
    if (!isAnimatingRef.current) return;
    
    if (!videoRef.current || !canvasRef.current || currentFilter === "none") {
      animationRef.current = requestAnimationFrame(detectAndDrawFilter);
      return;
    }

    try {
      const video = videoRef.current;
      const canvas = canvasRef.current;
      const ctx = canvas.getContext("2d");
      if (!ctx) return;

      // canvasã®ã‚µã‚¤ã‚ºã‚’videoã¨åŒã˜ã«ã™ã‚‹
      if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
      }
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚»ãƒƒãƒˆ
      if (currentFilter === "beautify") {
        ctx.filter = "brightness(1.08) contrast(1.05) saturate(1.1)";
      } else if (currentFilter === "monochrome") {
        ctx.filter = "grayscale(1)";
      } else {
        ctx.filter = "none";
      }
      
      // ã‚ºãƒ¼ãƒ åŠ¹æœã‚’é©ç”¨ï¼ˆuseRef ã‹ã‚‰æœ€æ–°ã®å€¤ã‚’å–å¾—ï¼‰
      const currentZoom = zoomLevelRef.current;
      const sourceWidth = video.videoWidth / currentZoom;
      const sourceHeight = video.videoHeight / currentZoom;
      const sourceX = (video.videoWidth - sourceWidth) / 2;
      const sourceY = (video.videoHeight - sourceHeight) / 2;
      
      // ãƒ“ãƒ‡ã‚ªãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æç”»ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä»˜ãï¼‰
      ctx.drawImage(video, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, video.videoWidth, video.videoHeight);
      ctx.filter = "none";
    } catch (err) {
      console.error("ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ã‚¨ãƒ©ãƒ¼:", err);
    }

    if (isAnimatingRef.current) {
      animationRef.current = requestAnimationFrame(detectAndDrawFilter);
    }
  }, [currentFilter]);

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰æç”»é–‹å§‹
  useEffect(() => {
    // å‰ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Œå…¨ã«åœæ­¢
    const stopAnimation = () => {
      isAnimatingRef.current = false;
      if (animationRef.current) {
        cancelAnimationFrame(animationRef.current);
        animationRef.current = null;
      }
      // canvasã‚’ã‚¯ãƒªã‚¢
      if (canvasRef.current) {
        const ctx = canvasRef.current.getContext("2d");
        if (ctx) {
          ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);
        }
      }
    };

    stopAnimation();

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿æ–°ã—ã„æç”»ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
    if (currentFilter !== "none" && cameraActive) {
      isAnimatingRef.current = true;
      detectAndDrawFilter();
    }

    return () => {
      stopAnimation();
    };
  }, [currentFilter, cameraActive, detectAndDrawFilter]);

  // ç¾è‚Œãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆã‚·ãƒ³ãƒ—ãƒ«å‡¦ç†ï¼‰
  const applyBeautifyFilter = (ctx: CanvasRenderingContext2D, width: number, height: number) => {
    // ç©ºã®é–¢æ•°ï¼ˆfilterã¯æç”»å‰ã«ã‚»ãƒƒãƒˆæ¸ˆã¿ï¼‰
  };

  // ãƒ¢ãƒã‚¯ãƒ­ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  const applyMonochromeFilter = (ctx: CanvasRenderingContext2D, width: number, height: number) => {
    // ç©ºã®é–¢æ•°ï¼ˆfilterã¯æç”»å‰ã«ã‚»ãƒƒãƒˆæ¸ˆã¿ï¼‰
  };

  return (
    <div style={{ minHeight: "100vh", background: "#000", color: "#fff", display: "flex", flexDirection: "column" }}>
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div
        style={{
          padding: "12px 16px",
          display: "flex",
          alignItems: "center",
          justifyContent: "space-between",
          background: "rgba(0,0,0,0.7)",
          backdropFilter: "blur(10px)",
        }}
      >
        <button
          onClick={() => router.back()}
          style={{
            background: "transparent",
            border: "none",
            color: "#fff",
            fontSize: 18,
            cursor: "pointer",
          }}
        >
          â† æˆ»ã‚‹
        </button>
      </div>

      {/* ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ / éŒ²ç”»æ¸ˆã¿å‹•ç”» */}
      <div style={{ flex: 1, display: "flex", alignItems: "center", justifyContent: "center", position: "relative" }}>
        {!recordedVideoUrl ? (
          <>
            <video
              ref={videoRef}
              autoPlay
              playsInline
              muted
              style={{
                width: "100%",
                height: "100%",
                objectFit: "cover",
                display: currentFilter === "none" ? "block" : "none",
                transform: `scale(${zoomLevelRef.current})`,
              }}
            />
            {isRecording && (
              <div
                style={{
                  position: "absolute",
                  top: 20,
                  left: "50%",
                  transform: "translateX(-50%)",
                  background: "rgba(255,0,0,0.8)",
                  padding: "8px 16px",
                  borderRadius: 20,
                  fontSize: 18,
                  fontWeight: 700,
                  display: "flex",
                  alignItems: "center",
                  gap: 8,
                }}
              >
                <div
                  style={{
                    width: 12,
                    height: 12,
                    borderRadius: "50%",
                    background: "#fff",
                    animation: "pulse 1s infinite",
                  }}
                />
                {formatTime(recordingTime)}
              </div>
            )}
            {/* å³å´ã®ç¸¦ä¸¦ã³ãƒœã‚¿ãƒ³ */}
            <div
              style={{
                position: "absolute",
                right: 14,
                top: "50%",
                transform: "translateY(-50%)",
                display: "flex",
                flexDirection: "column",
                gap: 16,
                alignItems: "center",
                zIndex: 20,
              }}
            >
              {cameraActive && !recordedVideoUrl && (
                <button
                  onClick={toggleCamera}
                  style={{
                    width: 50,
                    height: 50,
                    borderRadius: "50%",
                    border: "none",
                    background: "rgba(0,0,0,0.6)",
                    backdropFilter: "blur(10px)",
                    color: "#fff",
                    cursor: "pointer",
                    fontSize: 20,
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "center",
                    boxShadow: "0 4px 12px rgba(0,0,0,0.3)",
                  }}
                  title="ã‚«ãƒ¡ãƒ©åˆ‡æ›¿"
                >
                  ğŸ”„
                </button>
              )}
              <button
                onClick={() => router.push("/upload/cut")}
                style={{
                  width: 50,
                  height: 50,
                  borderRadius: "50%",
                  border: "none",
                  background: "rgba(0,0,0,0.6)",
                  backdropFilter: "blur(10px)",
                  color: "#fff",
                  cursor: "pointer",
                  fontSize: 24,
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  boxShadow: "0 4px 12px rgba(0,0,0,0.3)",
                }}
                title="ã‚«ãƒƒãƒˆç·¨é›†"
              >
                âœ‚ï¸
              </button>
              <button
                onClick={() => setShowFilterMenu(!showFilterMenu)}
                style={{
                  width: 50,
                  height: 50,
                  borderRadius: "50%",
                  border: "none",
                  background: currentFilter !== "none" ? `${themeColor}cc` : "rgba(0,0,0,0.6)",
                  backdropFilter: "blur(10px)",
                  color: "#fff",
                  cursor: "pointer",
                  fontSize: 24,
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  boxShadow: currentFilter !== "none" ? `0 0 20px ${themeColor}` : "0 4px 12px rgba(0,0,0,0.3)",
                }}
                title="ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ"
              >
                âœ¨
              </button>
              <button
                onClick={zoomOut}
                disabled={zoomLevelRef.current <= 1}
                style={{
                  width: 50,
                  height: 50,
                  borderRadius: "50%",
                  border: "none",
                  background: "rgba(0,0,0,0.6)",
                  backdropFilter: "blur(10px)",
                  color: zoomLevelRef.current <= 1 ? "#666" : "#fff",
                  cursor: zoomLevelRef.current <= 1 ? "not-allowed" : "pointer",
                  fontSize: 24,
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  boxShadow: "0 4px 12px rgba(0,0,0,0.3)",
                }}
                title="ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆ"
              >
                ğŸ”â–
              </button>
              <button
                onClick={zoomIn}
                disabled={zoomLevelRef.current >= 3}
                style={{
                  width: 50,
                  height: 50,
                  borderRadius: "50%",
                  border: "none",
                  background: "rgba(0,0,0,0.6)",
                  backdropFilter: "blur(10px)",
                  color: zoomLevelRef.current >= 3 ? "#666" : "#fff",
                  cursor: zoomLevelRef.current >= 3 ? "not-allowed" : "pointer",
                  fontSize: 24,
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  boxShadow: "0 4px 12px rgba(0,0,0,0.3)",
                }}
                title="ã‚ºãƒ¼ãƒ ã‚¤ãƒ³"
              >
                ğŸ”â•
              </button>
            </div>
            
            {/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ */}
            {showFilterMenu && (
              <div
                style={{
                  position: "absolute",
                  bottom: 100,
                  left: "50%",
                  transform: "translateX(-50%)",
                  display: "flex",
                  gap: 12,
                  padding: "12px 16px",
                  background: "rgba(0,0,0,0.8)",
                  backdropFilter: "blur(10px)",
                  borderRadius: 16,
                  boxShadow: "0 8px 32px rgba(0,0,0,0.5)",
                  zIndex: 30,
                }}
              >
                {[
                  { type: "none" as FilterType, emoji: "ğŸš«", label: "ãªã—" },
                  { type: "beautify" as FilterType, emoji: "âœ¨", label: "ç¾è‚Œ" },
                  { type: "monochrome" as FilterType, emoji: "ğŸ¨", label: "ãƒ¢ãƒã‚¯ãƒ­" },
                ].map((filter) => (
                  <button
                    key={filter.type}
                    onClick={() => {
                      setCurrentFilter(filter.type);
                      setShowFilterMenu(false);
                    }}
                    style={{
                      width: 50,
                      height: 50,
                      borderRadius: "50%",
                      border: currentFilter === filter.type ? `2px solid ${themeColor}` : "2px solid transparent",
                      background: currentFilter === filter.type ? `${themeColor}40` : "rgba(255,255,255,0.1)",
                      color: "#fff",
                      cursor: "pointer",
                      fontSize: 24,
                      display: "flex",
                      flexDirection: "column",
                      alignItems: "center",
                      justifyContent: "center",
                      boxShadow: currentFilter === filter.type ? `0 0 16px ${themeColor}` : "none",
                    }}
                    title={filter.label}
                  >
                    {filter.emoji}
                  </button>
                ))}
              </div>
            )}
            
            {/* ARãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ */}
            {currentFilter !== "none" && (
              <canvas
                ref={canvasRef}
                style={{
                  position: "absolute",
                  top: 0,
                  left: 0,
                  width: "100%",
                  height: "100%",
                  objectFit: "cover",
                  pointerEvents: "none",
                }}
              />
            )}
          </>
        ) : (
          <video
            src={recordedVideoUrl}
            controls
            style={{
              width: "100%",
              height: "100%",
              objectFit: "contain",
            }}
          />
        )}
      </div>

      {/* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */}
      <div
        style={{
          padding: "24px 16px 32px",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          gap: 20,
          background: "rgba(0,0,0,0.9)",
        }}
      >
        {!recordedVideoUrl ? (
          <>
            {!isRecording ? (
              <button
                onClick={startRecording}
                style={{
                  width: 80,
                  height: 80,
                  borderRadius: "50%",
                  background: themeColor,
                  border: "4px solid #fff",
                  cursor: "pointer",
                  fontSize: 24,
                  boxShadow: `0 4px 20px ${themeColor}80`,
                }}
              >
                â¬¤
              </button>
            ) : (
              <button
                onClick={stopRecording}
                style={{
                  width: 80,
                  height: 80,
                  borderRadius: 12,
                  background: "#fff",
                  border: "4px solid #f00",
                  cursor: "pointer",
                  fontSize: 24,
                }}
              >
                â– 
              </button>
            )}
          </>
        ) : (
          <>
            <button
              onClick={retake}
              style={{
                padding: "12px 24px",
                borderRadius: 8,
                background: "rgba(255,255,255,0.2)",
                border: "1px solid #fff",
                color: "#fff",
                cursor: "pointer",
                fontSize: 16,
                fontWeight: 600,
              }}
            >
              æ’®ã‚Šç›´ã—
            </button>
            <button
              onClick={saveVideo}
              style={{
                padding: "12px 32px",
                borderRadius: 8,
                background: themeColor,
                border: "none",
                color: "#fff",
                cursor: "pointer",
                fontSize: 16,
                fontWeight: 700,
                boxShadow: `0 4px 16px ${themeColor}80`,
              }}
            >
              ä¿å­˜
            </button>
          </>
        )}
      </div>

      <style>{`
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }
      `}</style>
    </div>
  );
}
